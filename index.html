<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Suivi transparent des promesses √©lectorales du Pr√©sident Bassirou Diomaye Faye">
  <meta name="theme-color" content="#2a6d5d">
  <meta property="og:title" content="Suivi Promesses ‚Ä¢ Diomaye Pr√©sident 2024">
  <meta property="og:description" content="Tableau de bord transparent de suivi des 99 engagements">
  <meta property="og:type" content="website">
  <title>Suivi Promesses ‚Ä¢ Diomaye Pr√©sident 2024</title>
  
  <!-- Fonts & Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-Avb2QiuDEEvB4bZJYdft2mNjVShBftLdPG8FJ0V7irTLQ8Uo0qcPxh4Plq7G5tGm0rU+1SPhVotteLpBERwTkw==" crossorigin="anonymous" referrerpolicy="no-referrer">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Styles -->
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="bg-pattern"></div>
  
  <div class="container">
    <header class="header">
      <div class="share-dashboard">
        <a href="#" id="share-twitter-dash" class="share-dashboard-btn share-twitter" title="Partager sur X" target="_blank">
          <i class="fab fa-x-twitter"></i>
        </a>
        <a href="#" id="share-facebook-dash" class="share-dashboard-btn share-facebook" title="Partager sur Facebook" target="_blank">
          <i class="fab fa-facebook-f"></i>
        </a>
        <a href="#" id="share-whatsapp-dash" class="share-dashboard-btn share-whatsapp" title="Partager sur WhatsApp" target="_blank">
          <i class="fab fa-whatsapp"></i>
        </a>
        <a href="#" id="share-linkedin-dash" class="share-dashboard-btn share-linkedin" title="Partager sur LinkedIn" target="_blank">
          <i class="fab fa-linkedin-in"></i>
        </a>
      </div>
      <div class="header-content">
        <h1>üá∏üá≥ Le Projet : Diomaye Pr√©sident</h1>
        <p class="subtitle">Tableau de Bord Transparent du Suivi des <span id="total-count">99</span> Engagements</p>
        <span class="ref-badge">
          <i class="fas fa-calendar-check"></i>
          Date de r√©f√©rence : 2 AVRIL 2024
        </span>
      </div>
    </header>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="total">0</div>
        <div class="stat-label">Engagements Total</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="realise">0</div>
        <div class="stat-label">‚úÖ R√©alis√©s</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="encours">0</div>
        <div class="stat-label">üîÑ En Cours</div>
      </div>
      <div class="stat-card stat-card-warning">
        <div class="stat-value" id="retard">0</div>
        <div class="stat-label">‚ö†Ô∏è En Retard</div>
      </div>
    </div>

    <div class="filters">
      <div class="input-group">
        <i class="fas fa-search"></i>
        <input type="text" id="search" placeholder="Rechercher un engagement...">
      </div>
      <div class="input-group">
        <i class="fas fa-filter"></i>
        <select id="domaine">
          <option value="">Tous les secteurs</option>
        </select>
      </div>
      <div class="input-group">
        <i class="fas fa-chart-bar"></i>
        <select id="status">
          <option value="">Tous les statuts</option>
          <option value="realise">‚úÖ R√©alis√©</option>
          <option value="en-retard">‚ö†Ô∏è En Retard</option>
          <option value="dans-les-temps">‚è±Ô∏è Dans les d√©lais</option>
          <option value="non-lance">‚è≥ Non lanc√©</option>
        </select>
      </div>
    </div>

    <div class="promises-grid" id="promises-container">
      <div class="loading">
        <div class="spinner"></div>
        <p>Chargement des donn√©es...</p>
      </div>
    </div>

    <footer class="footer">
      <p>Plateforme citoyenne de suivi des engagements ‚Ä¢ Donn√©es √† jour au <span id="current-date"></span></p>
      <div class="footer-links">
        <button onclick="showUpdateGuide()" class="update-link">
          <i class="fas fa-sync-alt"></i> Comment mettre √† jour
        </button>
        <button onclick="exportData()" class="update-link" style="margin-left: 1rem;">
          <i class="fas fa-download"></i> Exporter donn√©es
        </button>
      </div>
      <p class="footer-note">
        D√©velopp√© avec <i class="fas fa-heart" style="color: #e76f51;"></i> pour la transparence d√©mocratique
      </p>
    </footer>
  </div>

  <!-- JavaScript en UN SEUL fichier -->
  <script>
    // Configuration globale
    window.CONFIG = {
      DATA_URL: 'promises.json',
      START_DATE: null,
      CURRENT_DATE: new Date(),
      promises: []
    };

    // Fonctions utilitaires
    function calculateDeadline(delaiText) {
      if (!CONFIG.START_DATE) return new Date();
      const text = delaiText.toLowerCase();
      const result = new Date(CONFIG.START_DATE);
      
      if (text.includes("imm√©diat") || text.includes("3 mois") || text.includes("court terme")) {
        result.setMonth(result.getMonth() + 3);
      } else if (text.includes("6 premiers mois") || text.includes("6 mois")) {
        result.setMonth(result.getMonth() + 6);
      } else if (text.includes("12 premiers mois") || text.includes("1√®re ann√©e") || text.includes("1 an")) {
        result.setFullYear(result.getFullYear() + 1);
      } else if (text.includes("2 premi√®res ann√©es") || text.includes("2 ans") || text.includes("1 √† 2 ans")) {
        result.setFullYear(result.getFullYear() + 2);
      } else if (text.includes("3 ans") || text.includes("2 √† 3 ans")) {
        result.setFullYear(result.getFullYear() + 3);
      } else if (text.includes("4 ans") || text.includes("3 √† 4 ans")) {
        result.setFullYear(result.getFullYear() + 4);
      } else if (text.includes("5 ans") || text.includes("quinquennat") || text.includes("mandat") || text.includes("3 √† 5 ans") || text.includes("5 √† 10 ans")) {
        result.setFullYear(result.getFullYear() + 5);
      } else if (text.includes("2027")) {
        return new Date('2027-01-01');
      } else if (text.includes("2029")) {
        return new Date('2029-01-01');
      } else if (text.includes("2030")) {
        return new Date('2030-01-01');
      } else {
        result.setFullYear(result.getFullYear() + 5);
      }
      
      return result;
    }

    function checkIfLate(status, deadline) {
      return status !== 'realise' && CONFIG.CURRENT_DATE > deadline;
    }

    function updateCurrentDate() {
      const dateElement = document.getElementById('current-date');
      if (dateElement) {
        const options = { day: 'numeric', month: 'long', year: 'numeric' };
        dateElement.textContent = CONFIG.CURRENT_DATE.toLocaleDateString('fr-FR', options);
      }
    }

    // Rendu des statistiques
    function renderStats() {
      const promises = CONFIG.promises;
      const total = promises.length;
      const realise = promises.filter(p => p.status === 'realise').length;
      const encours = promises.filter(p => p.status === 'encours').length;
      const nonLance = promises.filter(p => p.status === 'non-lance').length;
      const retard = promises.filter(p => p.isLate).length;
      
      document.getElementById('total').textContent = total;
      document.getElementById('realise').textContent = realise;
      document.getElementById('encours').textContent = encours + nonLance; // On combine pour l'affichage
      document.getElementById('retard').textContent = retard;
      document.getElementById('total-count').textContent = total;
    }

    // Rendu des filtres
    function renderFilters() {
      const domainFilter = document.getElementById('domaine');
      const domains = [...new Set(CONFIG.promises.map(p => p.domaine))].sort();
      
      domainFilter.innerHTML = '<option value="">Tous les secteurs</option>';
      
      domains.forEach(domain => {
        const option = document.createElement('option');
        option.value = domain;
        option.textContent = domain;
        domainFilter.appendChild(option);
      });
    }

    // Cr√©er les boutons de partage pour une promesse
    function createShareButtons(promise) {
      const url = encodeURIComponent(window.location.href + '#' + promise.id);
      const text = encodeURIComponent(`üìä ${promise.engagement.substring(0, 100)}... - Suivi sur Diomaye Pr√©sident`);
      
      return `
        <div class="share-section">
          <a href="https://twitter.com/intent/tweet?text=${text}&url=${url}" 
             class="share-btn share-twitter" 
             target="_blank" 
             title="Partager sur X">
            <i class="fab fa-x-twitter"></i>
          </a>
          <a href="https://www.facebook.com/sharer/sharer.php?u=${url}" 
             class="share-btn share-facebook" 
             target="_blank" 
             title="Partager sur Facebook">
            <i class="fab fa-facebook-f"></i>
          </a>
          <a href="https://wa.me/?text=${text}%20${url}" 
             class="share-btn share-whatsapp" 
             target="_blank" 
             title="Partager sur WhatsApp">
            <i class="fab fa-whatsapp"></i>
          </a>
        </div>
      `;
    }

    // Rendu des promesses
    function renderPromises(promises) {
      const container = document.getElementById('promises-container');
      
      if (promises.length === 0) {
        container.innerHTML = `
          <div class="no-results" style="text-align:center; padding:3rem; color:#666; grid-column:1/-1;">
            <i class="fas fa-search fa-3x" style="margin-bottom:1rem;"></i>
            <h3>Aucun r√©sultat trouv√©</h3>
            <p>Essayez de modifier vos crit√®res de recherche</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = promises.map(promise => {
        const isLate = promise.isLate;
        let statusClass, statusText;
        
        switch(promise.status) {
          case 'realise':
            statusClass = 'status-realise';
            statusText = '‚úÖ R√©alis√©';
            break;
          case 'encours':
            statusClass = 'status-encours';
            statusText = 'üîÑ En Cours';
            break;
          case 'non-lance':
            statusClass = 'status-nonlance';
            statusText = '‚è≥ Non lanc√©';
            break;
          default:
            statusClass = 'status-encours';
            statusText = 'üîÑ En Cours';
        }
        
        // Badge de d√©lai
        let delayBadge = '';
        if (promise.status === 'realise') {
          delayBadge = '<span class="delay-badge delay-success"><i class="fas fa-check-circle"></i> Termin√©</span>';
        } else if (isLate) {
          delayBadge = '<span class="delay-badge delay-danger"><i class="fas fa-exclamation-triangle"></i> En Retard</span>';
        } else {
          delayBadge = '<span class="delay-badge" style="background:#e3f2fd; color:#3d5a80; padding:0.3rem 0.8rem; border-radius:20px; font-size:0.8rem;"><i class="fas fa-hourglass-half"></i> Dans les d√©lais</span>';
        }
        
        // Mises √† jour
        let updatesHTML = '';
        if (promise.mises_a_jour && promise.mises_a_jour.length > 0) {
          const updates = promise.mises_a_jour.map(update => `
            <div style="margin-top:0.5rem; padding:0.5rem 0; border-bottom:1px solid #eee;">
              <small style="color:#2a6d5d; font-weight:bold;"><i class="fas fa-calendar-alt"></i> ${update.date}</small>
              <p style="margin:0.2rem 0; color:#555;">${update.text}</p>
            </div>
          `).join('');
          
          updatesHTML = `
            <button class="details-btn" onclick="toggleUpdates('${promise.id}')">
              <i class="fas fa-history"></i> Voir les mises √† jour (${promise.mises_a_jour.length})
            </button>
            <div id="updates-${promise.id}" class="updates-container">
              <strong><i class="fas fa-newspaper"></i> Historique des mises √† jour</strong>
              ${updates}
            </div>
          `;
        }
        
        // Partager cette promesse
        const shareButtons = createShareButtons(promise);
        
        return `
          <div class="promise-card" id="${promise.id}">
            <span class="domain-badge">${promise.domaine}</span>
            <h3 class="promise-title">${promise.engagement}</h3>
            
            <div class="result-box">
              <i class="fas fa-bullseye"></i> 
              <strong>R√©sultat attendu :</strong> ${promise.resultat}
            </div>
            
            <div class="promise-meta">
              <div class="meta-row">
                <span><i class="fas fa-clock"></i> D√©lai : <strong>${promise.delai}</strong></span>
                ${delayBadge}
              </div>
              <div class="meta-row">
                <span>Statut :</span>
                <span class="status-badge ${statusClass}">${statusText}</span>
              </div>
            </div>
            
            ${updatesHTML}
            
            <div class="rating-section">
              <div class="stars" onclick="ratePromise('${promise.id}', event)">
                <i class="far fa-star" data-value="1"></i>
                <i class="far fa-star" data-value="2"></i>
                <i class="far fa-star" data-value="3"></i>
                <i class="far fa-star" data-value="4"></i>
                <i class="far fa-star" data-value="5"></i>
              </div>
              <span class="rating-label" id="rating-label-${promise.id}">
                Noter cet engagement
              </span>
            </div>
            
            ${shareButtons}
          </div>
        `;
      }).join('');
    }

    // Basculer l'affichage des mises √† jour
    window.toggleUpdates = function(promiseId) {
      const updatesEl = document.getElementById(`updates-${promiseId}`);
      const btn = updatesEl.previousElementSibling;
      
      if (updatesEl.classList.contains('show')) {
        updatesEl.classList.remove('show');
        btn.innerHTML = '<i class="fas fa-history"></i> Voir les mises √† jour';
      } else {
        updatesEl.classList.add('show');
        btn.innerHTML = '<i class="fas fa-times-circle"></i> Masquer les mises √† jour';
      }
    };

    // Noter une promesse
    window.ratePromise = function(promiseId, event) {
      if (event.target.classList.contains('fa-star')) {
        const rating = parseInt(event.target.getAttribute('data-value'));
        const stars = event.target.parentElement.querySelectorAll('.fa-star');
        
        // Mettre √† jour l'affichage des √©toiles
        stars.forEach((star, index) => {
          if (index < rating) {
            star.classList.remove('far');
            star.classList.add('fas', 'filled');
          } else {
            star.classList.remove('fas', 'filled');
            star.classList.add('far');
          }
        });
        
        // Sauvegarder en localStorage
        const promise = CONFIG.promises.find(p => p.id === promiseId);
        if (promise) {
          if (!promise.votes) promise.votes = [];
          promise.votes.push(rating);
          localStorage.setItem(`vote_${promiseId}`, JSON.stringify(promise.votes));
          
          // Mettre √† jour le label
          const avg = promise.votes.reduce((a, b) => a + b, 0) / promise.votes.length;
          document.getElementById(`rating-label-${promiseId}`).textContent = 
            `Note : ${avg.toFixed(1)}/5 (${promise.votes.length} vote${promise.votes.length > 1 ? 's' : ''})`;
          
          showNotification(`Merci ! Vous avez not√© ${rating}/5 cette promesse.`);
        }
      }
    };

    // Filtrage
    function setupEventListeners() {
      document.getElementById('search').addEventListener('input', updateDisplay);
      document.getElementById('domaine').addEventListener('change', updateDisplay);
      document.getElementById('status').addEventListener('change', updateDisplay);
    }

    function updateDisplay() {
      const search = document.getElementById('search').value.toLowerCase();
      const domaine = document.getElementById('domaine').value;
      const status = document.getElementById('status').value;
      
      const filtered = CONFIG.promises.filter(p => {
        const matchSearch = p.engagement.toLowerCase().includes(search) || 
                           p.resultat.toLowerCase().includes(search) ||
                           p.domaine.toLowerCase().includes(search);
        const matchDomaine = !domaine || p.domaine === domaine;
        
        let matchStatus = true;
        if (status === 'realise') {
          matchStatus = p.status === 'realise';
        } else if (status === 'en-retard') {
          matchStatus = p.isLate;
        } else if (status === 'dans-les-temps') {
          matchStatus = !p.isLate && p.status !== 'realise';
        } else if (status === 'non-lance') {
          matchStatus = p.status === 'non-lance';
        }
        
        return matchSearch && matchDomaine && matchStatus;
      });
      
      renderStats();
      renderPromises(filtered);
    }

    // Configuration des boutons de partage du dashboard
    function setupShareButtons() {
      const currentUrl = window.location.href;
      const shareText = encodeURIComponent('üá∏üá≥ Suivi transparent des 99 engagements du Pr√©sident Diomaye Faye - Tableau de bord citoyen');
      
      // Twitter/X
      document.getElementById('share-twitter-dash').href = 
        `https://twitter.com/intent/tweet?text=${shareText}&url=${encodeURIComponent(currentUrl)}`;
      
      // Facebook
      document.getElementById('share-facebook-dash').href = 
        `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(currentUrl)}`;
      
      // WhatsApp
      document.getElementById('share-whatsapp-dash').href = 
        `https://wa.me/?text=${shareText}%20${encodeURIComponent(currentUrl)}`;
      
      // LinkedIn
      document.getElementById('share-linkedin-dash').href = 
        `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(currentUrl)}`;
    }

    // Notification
    function showNotification(message) {
      const notification = document.createElement('div');
      notification.className = 'notification';
      notification.innerHTML = `
        <i class="fas fa-check-circle"></i>
        <span>${message}</span>
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // Exporter les donn√©es
    window.exportData = function() {
      const dataStr = JSON.stringify(CONFIG.promises, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
      const exportFileDefaultName = `promesses-diomaye-${new Date().toISOString().split('T')[0]}.json`;
      
      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportFileDefaultName);
      linkElement.click();
      
      showNotification('Donn√©es export√©es avec succ√®s !');
    };

    // Guide de mise √† jour
    window.showUpdateGuide = function() {
      alert("POUR METTRE √Ä JOUR LE SITE :\n\n1. Modifiez le fichier 'promises.json' sur GitHub\n2. Changez les 'status' : 'realise', 'encours', ou 'non-lance'\n3. Ajoutez des mises √† jour dans 'mises_a_jour'\n4. Sauvegardez (Commit changes)\n5. Attendez 1-2 minutes pour le d√©ploiement\n6. Rechargez la page pour voir les changements\n\nüìä Actuellement : 99 engagements dont 5 r√©alis√©s, 31 en cours, 63 non lanc√©s");
    };

    // Initialisation
    async function init() {
      try {
        const response = await fetch(CONFIG.DATA_URL);
        const data = await response.json();
        CONFIG.START_DATE = new Date(data.start_date);
        
        // Traiter toutes les promesses
        CONFIG.promises = data.promises.map(p => {
          const deadline = calculateDeadline(p.delai);
          return {
            ...p,
            deadline: deadline,
            isLate: checkIfLate(p.status, deadline),
            votes: JSON.parse(localStorage.getItem(`vote_${p.id}`)) || []
          };
        });
        
        updateCurrentDate();
        renderStats();
        renderFilters();
        renderPromises(CONFIG.promises); // Afficher TOUTES les promesses initialement
        setupEventListeners();
        setupShareButtons();
        
        console.log(`‚úÖ ${CONFIG.promises.length} promesses charg√©es`);
        
      } catch (error) {
        console.error('Erreur:', error);
        document.getElementById('promises-container').innerHTML = `
          <div style="text-align:center; padding:3rem; color:#e76f51; grid-column:1/-1;">
            <i class="fas fa-exclamation-triangle fa-3x"></i>
            <h3>Erreur de chargement</h3>
            <p>Impossible de charger les donn√©es promises.json</p>
            <button onclick="location.reload()" style="margin-top:1rem; padding:0.5rem 1rem; background:#2a6d5d; color:white; border:none; border-radius:5px; cursor:pointer;">
              <i class="fas fa-redo"></i> R√©essayer
            </button>
          </div>
        `;
      }
    }

    // D√©marrer l'application
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
